import{j as o,c as x}from"./client-Cii_oCSP.js";import{r as n,s as d,R as O}from"./vendor-BEgwZO9b.js";import{M as w,_ as A,L as B}from"./ironcalc-BhWIw97m.js";let L=!1;try{window.sessionStorage.getItem("__test__")}catch{L=!0}if(L){const t={},i={get length(){return Object.keys(t).length},key(s){return Object.keys(t)[s]??null},getItem(s){return Object.prototype.hasOwnProperty.call(t,s)?t[s]:null},setItem(s,f){t[s]=String(f)},removeItem(s){delete t[s]},clear(){Object.keys(t).forEach(s=>delete t[s])}};Object.defineProperty(window,"sessionStorage",{get:()=>i,configurable:!0})}const M=new URL("@ironcalc/wasm/wasm_bg.wasm",import.meta.url).href,S=["mouseup","keyup","change"],k=["pointerup","mouseup","keydown","keyup","paste","cut"],T=({noteVersion:t,noteText:i})=>{const[s,f]=n.useState(!0),[p,I]=n.useState(null),[l,N]=n.useState(null),b=n.useRef(null),y=n.useRef(-1),m=n.useRef(!1),u=n.useRef(null),E=n.useCallback(e=>{if(!(e!=null&&e.trim()))return null;try{const r=JSON.parse(e);return r.workbook&&typeof r.version=="number"?r:null}catch{return null}},[]),v=n.useCallback(e=>{const r=E(e);if(r!=null&&r.workbook)try{const c=Uint8Array.from(atob(r.workbook),h=>h.charCodeAt(0));return w.from_bytes(c)}catch(c){console.error("Failed to parse workbook:",c)}return new w("Spreadsheet","en","UTC")},[E]),a=n.useCallback(()=>{if(!(!l||!m.current))try{const e=l.toBytes(),r=btoa(String.fromCharCode(...e));if(r===u.current)return;d.text=JSON.stringify({workbook:r,version:1}),d.preview="IronCalc Spreadsheet",u.current=r}catch(e){console.error("Failed to save:",e)}},[l]),g=n.useCallback((e,r)=>{m.current=!1,y.current=e;const c=v(r);try{const h=c.toBytes();u.current=btoa(String.fromCharCode(...h))}catch{u.current=null}N(c),setTimeout(()=>{m.current=!0},500)},[v]);return n.useEffect(()=>{let e=!0;return(async()=>{try{const r=await fetch(M).then(c=>c.arrayBuffer());if(await A(r),!e)return}catch(r){console.error("Init failed:",r),e&&I("Failed to initialize spreadsheet engine")}finally{e&&f(!1)}})(),()=>{e=!1}},[]),n.useEffect(()=>{s||i!==void 0&&t!==y.current&&g(t,i)},[t,i,s,g]),n.useEffect(()=>{const e=()=>{document.hidden&&a()};return window.addEventListener("beforeunload",a),document.addEventListener("visibilitychange",e),()=>{window.removeEventListener("beforeunload",a),document.removeEventListener("visibilitychange",e)}},[a]),n.useEffect(()=>{const e=()=>{requestAnimationFrame(()=>a())};return k.forEach(r=>document.addEventListener(r,e,!0)),()=>{k.forEach(r=>document.removeEventListener(r,e,!0))}},[a]),n.useEffect(()=>{const e=b.current;if(e)return S.forEach(r=>e.addEventListener(r,a)),()=>{S.forEach(r=>e.removeEventListener(r,a))}},[a]),p?o.jsxs("div",{className:"spreadsheet-error",children:[o.jsx("span",{className:"error-icon",children:"⚠️"}),o.jsx("span",{children:p})]}):s||!l?o.jsxs("div",{className:"spreadsheet-loading",children:[o.jsx("div",{className:"loading-spinner"}),o.jsx("span",{children:"Loading spreadsheet..."})]}):o.jsx("div",{ref:b,className:"spreadsheet-container",children:o.jsx(B,{model:l,refreshId:0})})},V=x.createRoot(document.getElementById("root"));let R=0,j,_;const C=()=>{V.render(o.jsx(O.StrictMode,{children:o.jsx(T,{noteVersion:R,noteText:_})}))};d.initialize({debounceSave:400});d.subscribe(t=>{t!==j&&(_=t,j=t,R++,C())});C();
