import{j as o,c as O}from"./client-Cii_oCSP.js";import{r as n,s as d,R as x}from"./vendor-BEgwZO9b.js";import{M as g,_ as A,L as M}from"./ironcalc-BhWIw97m.js";let R=!1;try{window.sessionStorage.getItem("__test__")}catch{R=!0}if(R){const t={},i={get length(){return Object.keys(t).length},key(s){return Object.keys(t)[s]??null},getItem(s){return Object.prototype.hasOwnProperty.call(t,s)?t[s]:null},setItem(s,f){t[s]=String(f)},removeItem(s){delete t[s]},clear(){Object.keys(t).forEach(s=>delete t[s])}};Object.defineProperty(window,"sessionStorage",{get:()=>i,configurable:!0})}const B=""+new URL("wasm_bg-DuUdORlS.wasm",import.meta.url).href,S=["mouseup","keyup","change"],k=["pointerup","mouseup","keydown","keyup","paste","cut"],T=({noteVersion:t,noteText:i})=>{const[s,f]=n.useState(!0),[p,I]=n.useState(null),[l,N]=n.useState(null),b=n.useRef(null),y=n.useRef(-1),m=n.useRef(!1),u=n.useRef(null),E=n.useCallback(r=>{if(!(r!=null&&r.trim()))return null;try{const e=JSON.parse(r);return e.workbook&&typeof e.version=="number"?e:null}catch{return null}},[]),v=n.useCallback(r=>{const e=E(r);if(e!=null&&e.workbook)try{const c=Uint8Array.from(atob(e.workbook),h=>h.charCodeAt(0));return g.from_bytes(c)}catch(c){console.error("Failed to parse workbook:",c)}return new g("Spreadsheet","en","UTC")},[E]),a=n.useCallback(()=>{if(!(!l||!m.current))try{const r=l.toBytes(),e=btoa(String.fromCharCode(...r));if(e===u.current)return;d.text=JSON.stringify({workbook:e,version:1}),d.preview="IronCalc Spreadsheet",u.current=e}catch(r){console.error("Failed to save:",r)}},[l]),w=n.useCallback((r,e)=>{m.current=!1,y.current=r;const c=v(e);try{const h=c.toBytes();u.current=btoa(String.fromCharCode(...h))}catch{u.current=null}N(c),setTimeout(()=>{m.current=!0},500)},[v]);return n.useEffect(()=>{let r=!0;return(async()=>{try{const e=await fetch(B);if(!e.ok)throw new Error(`Failed to fetch wasm: ${e.status}`);if(await A(await e.arrayBuffer()),!r)return}catch(e){console.error("Init failed:",e),r&&I("Failed to initialize spreadsheet engine")}finally{r&&f(!1)}})(),()=>{r=!1}},[]),n.useEffect(()=>{s||i!==void 0&&t!==y.current&&w(t,i)},[t,i,s,w]),n.useEffect(()=>{const r=()=>{document.hidden&&a()};return window.addEventListener("beforeunload",a),document.addEventListener("visibilitychange",r),()=>{window.removeEventListener("beforeunload",a),document.removeEventListener("visibilitychange",r)}},[a]),n.useEffect(()=>{const r=()=>{requestAnimationFrame(()=>a())};return k.forEach(e=>document.addEventListener(e,r,!0)),()=>{k.forEach(e=>document.removeEventListener(e,r,!0))}},[a]),n.useEffect(()=>{const r=b.current;if(r)return S.forEach(e=>r.addEventListener(e,a)),()=>{S.forEach(e=>r.removeEventListener(e,a))}},[a]),p?o.jsxs("div",{className:"spreadsheet-error",children:[o.jsx("span",{className:"error-icon",children:"⚠️"}),o.jsx("span",{children:p})]}):s||!l?o.jsxs("div",{className:"spreadsheet-loading",children:[o.jsx("div",{className:"loading-spinner"}),o.jsx("span",{children:"Loading spreadsheet..."})]}):o.jsx("div",{ref:b,className:"spreadsheet-container",children:o.jsx(M,{model:l,refreshId:0})})},F=O.createRoot(document.getElementById("root"));let L=0,j,_;const C=()=>{F.render(o.jsx(x.StrictMode,{children:o.jsx(T,{noteVersion:L,noteText:_})}))};d.initialize({debounceSave:400});d.subscribe(t=>{t!==j&&(_=t,j=t,L++,C())});C();
