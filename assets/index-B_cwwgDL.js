import{j as s,c as x}from"./client-Cii_oCSP.js";import{r as n,s as d,R as O}from"./vendor-BEgwZO9b.js";import{M as S,_ as A,L as M}from"./ironcalc-BhWIw97m.js";let L=!1;try{window.sessionStorage.getItem("__test__")}catch{L=!0}if(L){const t={},i={get length(){return Object.keys(t).length},key(o){return Object.keys(t)[o]??null},getItem(o){return Object.prototype.hasOwnProperty.call(t,o)?t[o]:null},setItem(o,f){t[o]=String(f)},removeItem(o){delete t[o]},clear(){Object.keys(t).forEach(o=>delete t[o])}};Object.defineProperty(window,"sessionStorage",{get:()=>i,configurable:!0})}const k=["mouseup","keyup","change"],w=["pointerup","mouseup","keydown","keyup","paste","cut"],T=({noteVersion:t,noteText:i})=>{const[o,f]=n.useState(!0),[p,I]=n.useState(null),[l,N]=n.useState(null),b=n.useRef(null),y=n.useRef(-1),m=n.useRef(!1),u=n.useRef(null),E=n.useCallback(e=>{if(!(e!=null&&e.trim()))return null;try{const r=JSON.parse(e);return r.workbook&&typeof r.version=="number"?r:null}catch{return null}},[]),v=n.useCallback(e=>{const r=E(e);if(r!=null&&r.workbook)try{const c=Uint8Array.from(atob(r.workbook),h=>h.charCodeAt(0));return S.from_bytes(c)}catch(c){console.error("Failed to parse workbook:",c)}return new S("Spreadsheet","en","UTC")},[E]),a=n.useCallback(()=>{if(!(!l||!m.current))try{const e=l.toBytes(),r=btoa(String.fromCharCode(...e));if(r===u.current)return;d.text=JSON.stringify({workbook:r,version:1}),d.preview="IronCalc Spreadsheet",u.current=r}catch(e){console.error("Failed to save:",e)}},[l]),g=n.useCallback((e,r)=>{m.current=!1,y.current=e;const c=v(r);try{const h=c.toBytes();u.current=btoa(String.fromCharCode(...h))}catch{u.current=null}N(c),setTimeout(()=>{m.current=!0},500)},[v]);return n.useEffect(()=>{let e=!0;return(async()=>{try{if(await A(),!e)return}catch(r){console.error("Init failed:",r),e&&I("Failed to initialize spreadsheet engine")}finally{e&&f(!1)}})(),()=>{e=!1}},[]),n.useEffect(()=>{o||i!==void 0&&t!==y.current&&g(t,i)},[t,i,o,g]),n.useEffect(()=>{const e=()=>{document.hidden&&a()};return window.addEventListener("beforeunload",a),document.addEventListener("visibilitychange",e),()=>{window.removeEventListener("beforeunload",a),document.removeEventListener("visibilitychange",e)}},[a]),n.useEffect(()=>{const e=()=>{requestAnimationFrame(()=>a())};return w.forEach(r=>document.addEventListener(r,e,!0)),()=>{w.forEach(r=>document.removeEventListener(r,e,!0))}},[a]),n.useEffect(()=>{const e=b.current;if(e)return k.forEach(r=>e.addEventListener(r,a)),()=>{k.forEach(r=>e.removeEventListener(r,a))}},[a]),p?s.jsxs("div",{className:"spreadsheet-error",children:[s.jsx("span",{className:"error-icon",children:"⚠️"}),s.jsx("span",{children:p})]}):o||!l?s.jsxs("div",{className:"spreadsheet-loading",children:[s.jsx("div",{className:"loading-spinner"}),s.jsx("span",{children:"Loading spreadsheet..."})]}):s.jsx("div",{ref:b,className:"spreadsheet-container",children:s.jsx(M,{model:l,refreshId:0})})},B=x.createRoot(document.getElementById("root"));let R=0,j,C;const _=()=>{B.render(s.jsx(O.StrictMode,{children:s.jsx(T,{noteVersion:R,noteText:C})}))};d.initialize({debounceSave:400});d.subscribe(t=>{t!==j&&(C=t,j=t,R++,_())});_();
